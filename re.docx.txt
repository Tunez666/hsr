<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);

ini_set('session.gc_maxlifetime', 3600);
session_set_cookie_params(3600);
session_start();
require_once "connect.php";

$tableName = 'users';
$error = '';
$username = '';

if ($_SERVER["REQUEST_METHOD"] === "POST") {
    $username = trim($_POST['username'] ?? '');
    $password = trim($_POST['password'] ?? '');
    $ref_password = trim($_POST['ref_password'] ?? '');

    // === –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–ø—á–∏ ===
    if (empty($_POST['smart-token'])) {
        $error = "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ, —á—Ç–æ –≤—ã –Ω–µ —Ä–æ–±–æ—Ç";
    } else {
        $captchaToken = $_POST['smart-token'];
        $secret = 'ysc2_aOWIt8MfQ5fCzhfDLa7tjfG6bjZwo0R25Lgh9g052da55306';

        $ch = curl_init('https://smartcaptcha.yandexcloud.net/validate');
        curl_setopt_array($ch, [
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_POST => true,
            CURLOPT_POSTFIELDS => http_build_query([
                'secret' => $secret,
                'token'  => $captchaToken,
                'ip'     => $_SERVER['REMOTE_ADDR'] ?? ''
            ])
        ]);

        $response = curl_exec($ch);
        curl_close($ch);

        $captchaResult = json_decode($response, true);
        if (!isset($captchaResult['status']) || $captchaResult['status'] !== 'ok') {
            $error = "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ, —á—Ç–æ –≤—ã –Ω–µ —Ä–æ–±–æ—Ç (–æ—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞–ø—á–∏)";
        }
    }

    // === –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö ===
    if (empty($error)) {
        if ($username === '' || $password === '' || $ref_password === '') {
            $error = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è";
        }
        // üîê –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –ø–∞—Ä–æ–ª—è
        elseif (strlen($password) < 8) {
            $error = "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 8 —Å–∏–º–≤–æ–ª–æ–≤";
        }
        elseif ($password !== $ref_password) {
            $error = "–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç";
        } else {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            $query = "SELECT username FROM `$tableName` WHERE username = ?";
            $stmt = mysqli_prepare($Link, $query);

            if ($stmt) {
                mysqli_stmt_bind_param($stmt, "s", $username);
                mysqli_stmt_execute($stmt);
                $result = mysqli_stmt_get_result($stmt);

                if (mysqli_fetch_assoc($result)) {
                    $error = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –∏–º–µ–Ω–µ–º '$username' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç";
                } else {
                    $hashedPassword = password_hash($password, PASSWORD_DEFAULT);
                    $role = 'User';

                    $insertQuery = "INSERT INTO `$tableName` (username, password, role) VALUES (?, ?, ?)";
                    $stmtInsert = mysqli_prepare($Link, $insertQuery);

                    if ($stmtInsert) {
                        mysqli_stmt_bind_param($stmtInsert, "sss", $username, $hashedPassword, $role);
                        mysqli_stmt_execute($stmtInsert);
                        mysqli_stmt_close($stmtInsert);

                        $_SESSION['user'] = $username;
                        $_SESSION['role'] = $role;

                        header("Location: lk.php");
                        exit();
                    } else {
                        $error = "–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö";
                    }
                }
                mysqli_stmt_close($stmt);
            } else {
                $error = "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö";
            }
        }
    }
}
?>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="main.css">
    <script src="https://smartcaptcha.yandexcloud.net/captcha.js" defer></script>
</head>
<body>

<div class="content2">
    <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>

    <?php if (!empty($error)): ?>
        <div class="error-message"><?= htmlspecialchars($error) ?></div>
    <?php endif; ?>

    <form class="form" method="POST" autocomplete="off">
        <div class="form-group">
            <label for="username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
            <input
                type="text"
                id="username"
                name="username"
                required
                value="<?= htmlspecialchars($username) ?>"
                class="<?= strpos($error, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å') !== false ? 'input-error' : '' ?>"
            >
        </div>

        <div class="form-group">
            <label for="password">–ü–∞—Ä–æ–ª—å:</label>
            <input
                type="password"
                id="password"
                name="password"
                required
                minlength="8"
                class="<?= strpos($error, '–ü–∞—Ä–æ–ª—å') !== false ? 'input-error' : '' ?>"
            >
            <small class="hint">–ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤</small>
        </div>

        <div class="form-group">
            <label for="ref_password">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:</label>
            <input
                type="password"
                id="ref_password"
                name="ref_password"
                required
                minlength="8"
                class="<?= strpos($error, '–ü–∞—Ä–æ–ª—å') !== false ? 'input-error' : '' ?>"
            >
        </div>

        <!-- SmartCaptcha -->
        <div
            style="height:100px"
            class="smart-captcha"
            data-sitekey="ysc1_aOWIt8MfQ5fCzhfDLa7tJBAvillAETwc9iIVfI2K0ce088b6">
        </div>

        <input type="submit" value="–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è">
    </form>

    <center>
        <p><a href="login.php">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</a></p>
    </center>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("input").forEach(input => {
        input.addEventListener("input", () => {
            input.classList.remove("input-error");
        });
    });
});
</script>

</body>
</html>